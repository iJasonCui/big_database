Sybase Cluster Upgrade
Skip to end of metadata
Created by Courtney Messam, last modified yesterday at 8:12 PM Go to start of metadata
1 Fixes Target in SP130
2 Documents Related to Upgrade
3 Pre-Upgrade Tasks
4 Upgrade Procedure
4.1 Shut Down Sybase Installation
4.2 Shut Down Sybase Control Center
4.3 Backup Sybase Installation
4.4 Load New SAP SP130 Software/Binary
4.5 Run Setup
4.6 Start ASE Server
5 Post Installation Tasks
6 Shutdown and Restart Instance
7 Special Considerations
8 Downgrade/Rollback
8.1 Performing an In-Place Downgrade
 
This process describes the upgrade for Sybase Cluster - SP130
 
Fixes Target in SP130
Targeted CR List for ASE 15.7 SP130
Documents Related to Upgrade
SAP CE SP130 Documents
Pre-Upgrade Tasks
Shutdown all Applications that connect to the database server
Lock all connections except sa user
Kill connections
change sa password to prevent unnecessary connections
Replication Consideration
After applications have been stopped make sure the queue is drained
Send test transaction and make sure it makes it to replicate tables/Warm Standby
Suspend log transfer from all databases participating in the replication process
suspend log transfer from all
or 
suspend log transfer from <PrePRODQCluster.DB>
Logical Cluster Considerations
drop all logical clusters prior to upgrade
Upgrade Procedure
The upgrade will be done using binary overlay. This process is suggested only if the existing version is 15.7.x or later. We are currently running version 15.7 ESD#3.
Shut Down Sybase Installation
From your SYBASE directory, shut down SAP ASE through the shutdown cluster command in isql.. Use a regular "polite" shutdown as opposed to using the shutdown with nowait option, both as the initial and final steps. Doing so flushes free space accounting figures, object statistics, and runs checkpoint on the database to minimize recovery work during the upgrade process.
isql -Usa -SPrePRODInstance1 -w1000
> shutdown SYB_BACKUP
> go
> shutdown PrePRODInstance2 with wait = "00:03:00"
> go
> shutdown PrePRODInstance1 with wait = "00:03:00"
> go
Validate that all sybase server processes are down
sybasease@sq5prldb001d:/home/sybasease>$ showserver
F S UID PID PPID C PRI NI ADDR SZ WCHAN STIME TTY TIME CMD
sybasease@sq5prldb002d:/home/sybasease>$ showserver
F S UID PID PPID C PRI NI ADDR SZ WCHAN STIME TTY TIME CMD
 
Shut Down Sybase Control Center
If sybase control center is running shut this down
cd /opt/sybase/SCC-3_2/bin>$ ./scc.sh -stop
 
Backup Sybase Installation
As part of the roll back process we backup the $SYBASE installation. This is achieved using tar
cd $SYBASE
sybase@sq5prldb001d:/opt/sybase>$ tar -cvf sybase_pre_sp130.tar *
 
go to second instance and run the same command
cd $SYBASE
sybase@sq5prldb002d:/opt/sybase>$ tar -cvf sybase_pre_sp130.tar *
Verify tar dump
tar -tvf sybase_pre_sp130.tar
 
Load New SAP SP130 Software/Binary
Software has been downloaded to the directory /mnt/R5/dbbackup/download/SP130
Unzip the file 51048961.ZIP if it has not been already zipped
cd sybasease@sq5prldb002d:/mnt/R5/dbbackup/download/SP130
sybasease@sq5prldb002d:/mnt/R5/dbbackup/download/SP130>$ 51048961.ZIP
 
sybasease@sq5prldb002d:/mnt/R5/dbbackup/download/SP130>$ ls -l
total 1194100
-rw-r--r--  1 sybasease sybasease 1153512479 Nov 27 14:57 51048961.ZIP
dr-xr-xr-x 34 sybasease sybasease       4096 Aug 25 20:57 archives
-r-xr-xr-x  1 sybasease sybasease         67 Oct  6 17:50 CDLABEL.ASC
-r-xr-xr-x  1 sybasease sybasease         67 Oct  6 19:05 CDLABEL.EBC
-r-xr-xr-x  1 sybasease sybasease      79032 Jan  2  2014 COPY_TM.HTM
-r-xr-xr-x  1 sybasease sybasease      11058 Jan  2  2014 COPY_TM.TXT
-r-xr-xr-x  1 sybasease sybasease         20 Oct  6 17:50 LABEL.ASC
-r-xr-xr-x  1 sybasease sybasease         20 Oct  6 19:05 LABEL.EBC
-rw-r--r--  1 sybasease sybasease      12337 Oct  6 19:06 MD5FILE.DAT
-r-xr-xr-x  1 sybasease sybasease       8696 Sep 16 12:12 sample_response.txt
-r-xr-xr-x  1 sybasease sybasease   69048865 Sep 16 12:12 setup.bin
-rw-r--r--  1 sybasease sybasease      17534 Oct  6 19:06 SHAFILE.DAT
dr-xr-xr-x  3 sybasease sybasease       4096 Aug 25 20:57 sysam_setup
dr-xr-xr-x  4 sybasease sybasease       4096 Aug 25 20:57 sysam_utilities
dr-xr-xr-x  2 sybasease sybasease       4096 Aug 25 20:57 ThirdPartyLegal
-r-xr-xr-x  1 sybasease sybasease         22 Oct  6 17:50 VERSION.ASC
-r-xr-xr-x  1 sybasease sybasease         22 Oct  6 19:05 VERSION.EBC
 
Run Setup
 
cd sybasease@sq5prldb002d:/mnt/R5/dbbackup/download/SP130
sybasease@sq5prldb002d:/mnt/R5/dbbackup/download/SP130>$./setup.bin
 
Select the language. --> Next
Specify the destination directory with the SAP ASE you want to update, then click Next
If you see Choose Update Installation, this means that there is an older version of SAP ASE in the directory you specified for the installation.
If you click:
○Yes – the installer identifies which features you already have, and automatically updates them to the newest version.
Click Next.
The installer checks that the version you wish to update is compatible with the version of SAP ASE you are installing. If the version is incompatible, the Check Upgrade Incompatible Version dialog appears, and you see a message similar to:
Warning: The current "SAP Adaptive Server Enterprise Suite" in your destination directory is not compatible with this version upgrade; some bug fixes may be unavailable if you proceed. See the release note for more information.
Install SAP ASE 15.7 SP130 into the existing $SYBASE installation path.
At the end of the installation process, select Configure SAP Control Center, and set a new password for both the SCC admin and agent.
 
Start ASE Server
Once upgrade binary has been completed, start only one instance of the server
cd /opt/sybase/ASE-15_0/install>$
sybasease@sq5prldb001d:/opt/sybase/ASE-15_0/install>$./startserver -f ./RUN_PrePRODInstance1
The server will be upgraded during the start up process.
Post Installation Tasks
When you perform a minor upgrade/update from SAP ASE version 15.0 and later, you must also reinstall the scripts in $SYBASE/ASE-15_0/scripts/ as well as update the system stored procedures and messages from the earlier version of SAP ASE.
cd /opt/sybase/ASE-15_0/scripts
sybasease@sq5prldb001d:/opt/sybase/ASE-15_0/scripts>$isql -Usa -SPrePRODInstance1 -i installmaster -o installmaster.PrePROD.log
sybasease@sq5prldb001d:/opt/sybase/ASE-15_0/scripts>$isql -Usa -SPrePRODInstance1 -i instmsgs.ebf -o instmsgs.ebf.PrePROD.log
 
 
execute  dbcc upgrade_object for each database to explicitly re-compile the objects.
Execute:
dbcc gam (<database_name>,0,0,'check')
This command performs upgrade operations on text and image columns that are deferred during the SAP ASE upgrade process, and prevents dbcc checkstorage from taking a long time when it is run for the first time after the upgrade
 
Replication Server
Resume connections to the replication server system
resume log transfer from all
 
Shutdown and Restart Instance
After post upgrade task shutdown the current instance and restart it. Watch the error log for potential errors. Once the server comes up cleanly restart the second instance and watch for errors. If everything looks good we are raring to go.
Add logical Clusters that were removed and configure active-passive setup
Special Considerations
If we are dumping transactions  for databases we need to do a full dump of the database before we can do a transaction log dump. This is because the transaction log may contain older server version which cannot be interpreted correctly which would prevent recovery.
 
Downgrade/Rollback
Performing an In-Place Downgrade
Downgrade SAP ASE 15.7 SP130 to versions 15.5, 15.5 ESDs, 15.7, and 15.7 ESDs in place using the same installation directory the upgrade was performed from.Context
When downgrading from SAP ASE version 15.7 SP130 to version 15.5 ESD #4, you can perform the downgrade to the same Sybase installation directory where version 15.7 resides.Note
Although in-place downgrades are allowed, you have less risk of experiencing problems if you save all the data externally and perform a clean downgrade.
Procedure
Back up the entire contents of the current operating system's $SYBASE directory in case you need to revert back to it.
Place a database (@<db_name>) in single-user mode.
Run sp_downgrade 'prepare' to validate the readiness of SAP ASE for the downgrade:
sp_downgrade 'prepare', @toversion = '155'Perform any manual changes sp_downgrade 'prepare' identifies for your downgrade, and repeat the command until it displays no additional requirements.Note
Before you proceed, make sure you understand the implications of any sp_downgrade warnings displays before you proceed.
Installation Guide for Linux
SAP ASE Downgrades © 2014 SAP SE or an SAP affiliate company. All rights reserved. 175
4.Run sp_downgrade 'downgrade':
sp_downgrade 'downgrade', @toversion = '155, @override=1Once you successfully perform sp_downgrade 'downgrade', you cannot have any activity on the 15.7 server.
5.Run checkpoint, then immediately issue the shutdown command to shut down the 15.7 server.
6.(Optional) Make OS copies of any existing SAP ASE device files.
7.Install the SAP ASE version 15.5 EBF 18661 SMP ESD #4 binary overlay via ./setup, which starts InstallAnywhere in GUI mode.Note
At the end of the InstallAnywhere installation process, do not select Configure a Server.
Do not modify the RUN_server file, since the location of the files referenced in the file do not change in this downgrade method.
8. Start SAP ASE.
If you see error messages in the error log, perform post-downgrade tasks.
If you start a downgraded server using the 15.7 configuration file, the new options generate an Unknown parameter message. The unknown options are reported the first time you restart the server. You can ignore these messages; the configuration file is rewritten without the unknown options.Note
The keywords decrypt_default, xmltable, and path were added in the Cluster Edition of SAP ASE version 15.5, making it impossible to create identifiers using these names. You must change applications if you used these names.
